var n=class{constructor(t=null){this.scope=t,this.scopeName=t!==null?`${t.charAt(0).toUpperCase()}${t.slice(1)}`:null}log(...t){return console.log(...this._buildArgs("log",t))}info(...t){return console.info(...this._buildArgs("info",t))}debug(...t){return console.debug(...this._buildArgs("debug",t))}warn(...t){return console.warn(...this._buildArgs("warn",t))}error(...t){return console.error(...this._buildArgs("error",t))}_buildArgs(t,e){return[`(lookbook/${this.scope})`,...e]}};var o=class{constructor(t){this.endpoint=t,this.source=null,this.broadcastChannel=this.initBroadCastChannel(),this.handlers=[],this.logger=new n("EventsListener"),addEventListener("visibilitychange",()=>{document.hidden?this.stop():this.start()})}start(){this.source||(this.logger.debug("Starting"),this.source=this.initSource(),this.broadcastStart())}stop(){this.source&&(this.source.close(),this.source=null,this.logger.debug("Stopped"))}on(t,e){this.handlers.push({type:t,callback:e})}initSource(){let t=new EventSource(this.endpoint);return t.addEventListener("open",()=>{this.logger.debug(`Connected to '${this.endpoint}'`)}),t.addEventListener("message",e=>{let r=JSON.parse(e.data);this.broadcastChannel.postMessage(JSON.stringify(r)),this.handlers.forEach(s=>{r.type===s.type&&s.callback.call(null,r)})}),t.addEventListener("error",()=>{this.logger.warn("Event source error"),this.stop()}),window.onbeforeunload=()=>this.stop(),t}initBroadCastChannel(){let t=new BroadcastChannel("lookbook_events");return t.addEventListener("message",e=>{let r=JSON.parse(e.data);this.handlers.forEach(s=>{r.type===s.type&&s.callback.call(null,r)})}),t}broadcastStart(){this.broadcastChannel.postMessage(JSON.stringify({type:"event-source-start"}))}};export{o as ServerEventsListener};
