import{a as w}from"./chunk.BLB2YS7S.js";import{a as E}from"./chunk.PEZZYQ4F.js";import{b as f}from"./chunk.KPSBC2JF.js";import{a as u}from"./chunk.J33USGNF.js";import{a as m,b as l}from"./chunk.DJWHC2VF.js";import{a as d}from"./chunk.KPKYWVQS.js";import{a as v}from"./chunk.D2CJ6ZMJ.js";import{a as y}from"./chunk.ICSPRQYO.js";import{a as c,b as g,e as o}from"./chunk.XPFMMO3L.js";var a=class extends u{constructor(){super(),this.logger=new v("router"),window.addEventListener("popstate",this.handlePopstate)}connectedCallback(){this.delegate("click",this.handleClick),this.on("param:update",this.updateQueryParam),this.on("visit",this.handleVisit),this.on("reload",this.reload),this.on("reset",this.reset),this.sseEndpoint&&this.listenForServerEvents(),super.connectedCallback()}async visit(e,t=null,s={}){e=e.toString(),arguments.length==2&&typeof t=="object"&&(s=t,t=null);let{history:r=!1,strategy:i="morph"}=s,n={url:e,history:r,strategy:i};this.dispatch("before-visit",n),await this.updatePage(e,t,{strategy:i}),r&&window.history.pushState({},"",e),this.dispatch("after-visit",n)}reload(){this.visit(location)}async reset(){localStorage.clear(),window.location.reload()}listenForServerEvents(){this.serverEventsListener||(this.serverEventsListener=new E(this.sseEndpoint),this.serverEventsListener.on("update",()=>this.updatePage()),this.serverEventsListener.start(),this.cleanupJobs.push(()=>this.serverEventsListener.stop()))}handleVisit({detail:e}){this.visit(e.url,{history:!0})}handlePopstate(){window.location.href=location}handleClick(e){let t=e.target.closest("[href]");if(f(t)){e.preventDefault();let s=t.getAttribute("data-target");this.visit(t.href,s?`#${s}`:null,{history:!0})}}updateQueryParam(e){let{name:t,value:s}=e.detail,r=new URLSearchParams(location.search);r.set(t,s),this.visit(`${location.pathname}?${r.toString()}`,{history:!0})}async updatePage(e=location,t=null,s={strategy:"morph"}){this.logger.debug("Updating page",{url:e,selector:t||"lb-router"});let{strategy:r}=s;try{let i;t?i=this.querySelector(t):(t="lb-router",i=this);let n=await this.fetchHTML(e.toString(),t);n.ok?(this.logger.debug("Updating DOM",{strategy:r}),this.dispatch("before-morph"),r==="morph"?y(i,n.fragment.outerHTML):r==="replace"?i.replaceWith(n.fragment):this.logger.error(`Unknown strategy '${r}'`),n.title&&(document.title=n.title),this.dispatch("after-morph")):console.error(n)}catch(i){this.logger.error(i)}}async fetchHTML(e,t="lb-router",s={headers:{}}){let r=await fetch(e||location,g(c({},s),{headers:c({"X-Lookbook-Request":"true"},s.headers)})),{status:i,ok:n}=r,h={ok:n,status:i,response:r,fragment:void 0,title:null,url:r.url};if(i<500){let b=await r.text(),p=new DOMParser().parseFromString(b,"text/html");h.title=p.title,h.fragment=p.querySelector(t)}return h}render(){return d`<slot></slot>`}};a.css=w,o([l({attribute:"sse"})],a.prototype,"sseEndpoint",2),o([l()],a.prototype,"serverEventsListener",2),o([l()],a.prototype,"logger",2),a=o([m("lb-router")],a);export{a};
