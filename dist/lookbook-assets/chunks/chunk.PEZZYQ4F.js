import{a as r}from"./chunk.D2CJ6ZMJ.js";var n=class{constructor(t){this.endpoint=t,this.source=null,this.broadcastChannel=this.initBroadCastChannel(),this.handlers=[],this.logger=new r("EventsListener"),addEventListener("visibilitychange",()=>{document.hidden?this.stop():this.start()})}start(){this.source||(this.logger.debug("Starting"),this.source=this.initSource(),this.broadcastStart())}stop(){this.source&&(this.source.close(),this.source=null,this.logger.debug("Stopped"))}on(t,s){this.handlers.push({type:t,callback:s})}initSource(){let t=new EventSource(this.endpoint);return t.addEventListener("open",()=>{this.logger.debug(`Connected to '${this.endpoint}'`)}),t.addEventListener("message",s=>{let e=JSON.parse(s.data);this.broadcastChannel.postMessage(JSON.stringify(e)),this.handlers.forEach(a=>{e.type===a.type&&a.callback.call(null,e)})}),t.addEventListener("error",()=>{this.logger.warn("Event source error"),this.stop()}),window.onbeforeunload=()=>this.stop(),t}initBroadCastChannel(){let t=new BroadcastChannel("lookbook_events");return t.addEventListener("message",s=>{let e=JSON.parse(s.data);this.handlers.forEach(a=>{e.type===a.type&&a.callback.call(null,e)})}),t}broadcastStart(){this.broadcastChannel.postMessage(JSON.stringify({type:"event-source-start"}))}};export{n as a};
